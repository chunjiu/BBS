<%-include('./includes/header')%>
	<style type="text/css">
		.lightbox {
			position: fixed;
			top: 0px;
			left: 0px;
			height: 100%;
			width: 100%;
			z-index: 7;
			opacity: 0.3;
			display: block;
			background-color: rgb(0, 0, 0);
			display: none;
		}

		.pop,
		iframe {
			position: absolute;
			left: 50%;
			top: 0;
			width: 893px;
			height: 100%;
			margin-left: -446.5px;
			z-index: 9;
		}
	</style>
	<script src="/javascripts/pdf/pdf.js"></script>
	<script type="text/javascript">
		function showPdf(isShow) {
			var state = "";
			if (isShow) {
				state = "block";
			} else {
				state = "none";
			}
			var pop = document.getElementById("pop");
			pop.style.display = state;
			var lightbox = document.getElementById("lightbox");
			lightbox.style.display = state;
		}
		function close() {
			showPdf(false);
		}
	</script>

	<div class="row">

		<%-include('./includes/treeNav')%>
			<div class="col-md-9 carModelURL" carModelUrl='<%=typeof( carModelURL)!==' undefined '&& carModelURL||' '%>'>
				<%car_Brand.map(function(car){%>
					<%car.carModel.map(function(carModel){%>
						<div class="panel panel-default" carModel=<%=carModel%> style='display:none'>
							<div class="panel-heading" style='background-color:#EBE6E6;'>
								<span style='font-weight:900;'>当前车型</span>
							</div>
							<div>
								<div class="media">
									<div class="media-left">
										<img style='max-width:none;width:100px;height:100px;' src="/uploads/carModel/car.jpg">
									</div>
									<div class="media-body">
										<h4>厂家：
											<span>
												<%=car.carBrand%>
											</span>
										</h4>
										<h4>车型：
											<span>
												<%=carModel%>
											</span>
										</h4>
									</div>

									<div class="col-sm-8">

										<h3 style="font-weight:900;">年份：
											<%=carModel%>&nbsp;
											<%if(current_user.attr[0].admin){%>
												<select class="chooseYear" style='width:90px;'><!--上传选择年份-->
													<%car.carYear[0].carYear.map(function(carYear){%>
														<option>
															<%=carYear%>
														</option>
														<%})%>
												</select>
											<%}%>
													
												<select class="ChooseCarInformationYear" style='width:90px;'><!--查看资料时选择年份-->

													<!--对比两个对象的键值是否有相同，取相同值存进另一数组-->
													<%var carInformationYear = [];%>

													<%var le = car.carYear[0].carYear.length%>
													<%var lf =car.carInformation.length%>
													<%for(let i=0;i<le;i++){%>
														<%for(let j=0;j<lf;j++){%>
															<%var leYear=car.carYear[0].carYear[i]%>
															<%var lfYear=car.carInformation[j].carYear%>
																<%if(leYear==lfYear){%>
																	<%carInformationYear[leYear]=leYear%><!--有同一个leYear键替换相同值-->
																<%}%>
														<%}%>		
													<%}%>

												
												
													
													<%carInformationYear.map(function(year){%>
														<option><%=year%></option>
													<%})%>

												
												</select>
										</h3>

										<ul style="margin-bottom:30px;">

											<% car.carInformation.map(function(carInformation){%>
												<% if(carInformation.carModel==carModel){%>
													<li class="infoData" style='font-weight:900;font-size:15px;' carInformationYear='<%=carInformation.carYear%>'>
														<a href="<%=carInformation.carInformation%>" target="pdfContainer" onclick="showPdf(true)">
															<span class="glyphicon glyphicon-file"></span>
															【
															<span class="fileName">
																<%=carInformation.fileName%>
															</span>】
														</a>
														<a style='cursor: pointer; text-decoration: none;' class="glyphicon glyphicon-trash remove" Brand='<%=car.carBrand%>' Information='<%=carInformation.carInformation%>'
														 fileName='<%=carInformation.fileName%>'></a>

													</li>
													<% }%>
														<% })%>

															<li style='list-style-type: none;font-weight:900;margin-top:30px;'>

																<form class="from" method="post" action="/uploadInformation" enctype="multipart/form-data">
																	<input class="upfile" id="upInformation" name="upInformation" type="file" value="上传">
																	<p style='margin-top:10px;' class="btn btn-default upLoadData" id='upLoadInformation' carModel='<%=carModel%>' carBrand='<%=car.carBrand%>'>上传资料</p>
																</form>

															</li>
															<div style='display:none;'>
																<!--数组元素查询测试-->
																<input type="text" placeholder="年份">
																<input type='text' placeholder="车型">
																<button class="chek">查找年份</button>
															</div>

										</ul>
									</div>
									<!--col-sm-4-->

								</div>
							</div>
						</div>
						<%})%>
							<%})%>
								<!--
	            <div class="lightbox" id="lightbox"></div>
				<div id="pop" class="pop" style="display: none;">
					<a href="javascript:close()" style="
					position: absolute;
					right:-100px;
					display: inline-block;
					width: 80px;
					height: 30px;
					color:red;
					" id="close">关闭</a>
				   <iframe frameborder="0" id="pdfContainer" name="pdfContainer" style='height:800px;width:100%;'></iframe>
				
			    </div>-->
			</div>
			<!-- col-md-10 -->
	</div>




	<!--
	<div style="position: static; width: 0px; height: 0px; border: none; padding: 0px; margin: 0px;">
		<div id="trans-tooltip">
			<div id="tip-left-top" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-left-top.png&quot;);">
			</div>
			<div id="tip-top" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-top.png&quot;) repeat-x;">
			</div>
			<div id="tip-right-top" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-right-top.png&quot;);">
			</div>
			<div id="tip-right" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-right.png&quot;) repeat-y;">
			</div>
			<div id="tip-right-bottom" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-right-bottom.png&quot;);">
			</div>
			<div id="tip-bottom" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-bottom.png&quot;) repeat-x;">
			</div>
			<div id="tip-left-bottom" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-left-bottom.png&quot;);">
			</div>
			<div id="tip-left" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-left.png&quot;);">
			</div>
			<div id="trans-content">
			</div>
		</div>
		<div id="tip-arrow-bottom" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-arrow-bottom.png&quot;);">
		</div>
		<div id="tip-arrow-top" style="background: url(&quot;chrome-extension://ikkepelhgbcgmhhmcmpfkjmchccjblkd/imgs/map/tip-arrow-top.png&quot;);">
		</div>
	</div>
-->
	<!--是body的onload事件，注意这个script的摆放位置-->
	<script>

		//加载完时按选择的车型显示
		function showInformation() {
			console.log('加载完成');
			var carModelURL = $('.carModelURL').attr('carModelURL');
			console.log('Model是：' + carModelURL);
			$('.panel[carModel=' + carModelURL + ']').show();
		}

	</script>

	<script src="/javascripts/jquery-3.2.1.min.js"></script>
	<!--模版内引入js文件需在前面加'/'才能引入成功-->
	<script src="/javascripts/bootstrap.js"></script>
	<!--模版内引入js文件需在前面加'/'才能引入成功-->
	<script src="/javascripts/less.min.js" type="text/javascript"></script>

	</body>

	<script>
		/*$('#upload').click(function () {
			$this = $(this);
			var brother = $this.next();
			var upInformation = brother.find('#upInformation')
			console.log('查找到的值：'+upInformation);
			upInformation.click();
			// $('#upInformation').click();
		})*/
		$(document).ready(function () {
			/*
			$('.chek').click(function () {
				$this = $(this);
				let year = $this.prev().prev().val();
				let model = $this.prev().val();

				console.log('year是：' + year);
				console.log('model是：' + model);

				let action = '/chekYear';
				let data = {
					year: year,
					model: model
				}
				$.post(action, data, function () { })
			})*/

			/*获取上传文件*/
			$('.upfile').change(function () {
				console.log('获取文件');
				var fileNames = [];
				$('.fileName').map(function (index, elment) {
					let fileName = $(elment).text();
					fileNames.push(fileName);
				})
				var file = $(this).get(0).files[0];
				fileNames.map(function (fileName, index) {
					if (fileName === file.name) {//要去掉字符串前后空格

						let r = confirm('上传同一文件是为了更新吗?');
						if (r == true) {
							$this.next().show();
						}
					}
				})
				console.log('fileName是：' + file.name);
				console.log('fileNames是：' + fileNames);

			})

			/*上传文件*/
			let carYear;
			$('.chooseYear').change(function(){
				$this = $(this);
				let val = $this.val();
				carYear = val;
				console.log('val是：'+val);
			})
			$('.upLoadData').click(function () {
				$this = $(this);
				console.log('进入uploadData');
				let carModel = $this.attr('carModel');
				let carBrand = $this.attr('carBrand');
				
				console.log('carModel是：' + carModel);
				console.log('carBrand是:' + carBrand);
				console.log('carYear是:' + carYear);

				let url = $this.closest('.from').attr('action');
				let queryUrl = "?carBrand=" + carBrand + "&carYear=" + carYear + "&carModel=" + carModel;
				url = url + queryUrl;

				$('.from').attr('action', url);
				$('.from').submit();

			})



			/*删除资料*/
			$('.remove').click(function () {//不要用ID，ID只能获得第一个元素
				var $this = $(this);
				var carBrand = $this.attr('Brand');
				var carInformation = $this.attr('Information');
				var fileName = $this.attr('fileName');

				infoData = $this.closest('.infoData');
				console.log('carBrand是：' + carBrand);
				console.log('carInformation是：' + carInformation);
				var data = {
					carBrand: carBrand,
					carInformation: carInformation
				}
				let r = confirm('确认删除吗？')
				if (r == true) {
					let rn = confirm('您将删除   ' + fileName + '   这个文件')
					if (rn == true) {
						$.post('/removeInformation', data, function (data) {
							if (data.success) {
								infoData.remove();
							}
						})
					}
				}

			})

			//根据车型选择
			$('.chooseModel').click(function () {
				var $this = $(this);

				var carBrand = $this.attr('carBrand');
				var Model = $this.text();
				ModelURL = '&carModel=' + Model;
				carBrandUrl = '/information/?carBrand=' + carBrand + ModelURL;
				console.log('carModelUrl是：' + carBrandUrl);
				$this.attr('href', carBrandUrl);


				/*$('.panel').hide();
				$('.panel[carModel=' + Model + ']').show();*/


			})

			/*选择查看年份*/
			$('.ChooseCarInformationYear').change(function(){
				$this = $(this);
				let year = $this.val();
				console.log('year是：'+year)
				$('.infoData').hide();
				$('.infoData[carInformationYear='+year+']').show();
			})

			//汽车品牌侧边导航
			$('.tree').scroll(function () {
				var tree = $('.tree').offset().top;
				var navScrollLeft = $('.navscroll').offset().left;
				$('.navscroll').offset({ top: tree, left: navScrollLeft });

			})
			$(".carBrand,.treeFisrtWord").click(function () {
				var $this = $(this);
				var carModel = $this.next();
				carModel.toggle();
			});

			$(window).scroll(function () {
				console.log('进入window.scroll');
				var scrollTop = $(window).scrollTop();
				var head = $('.head');
				var nav = $('.navbar')

				var headHeight = head.height();
				var navHeight = nav.height();

				if (scrollTop > 130) {
					$('.tree').offset({ top: scrollTop })
				} else {
					$('.tree').offset({ top: headHeight + navHeight + 2 })
				}
			})

			$('.en').click(function () {
				console.log('点击');
				console.log(encodeURI('http://localhost:3000/uploads/carInformation/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BANode.js.www.java1234.com.pdf.pdf'))
			})
		})




	</script>

	</html>